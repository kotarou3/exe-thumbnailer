Author: James Lu <james@overdrivenetworks.com>
Subject: Switch to msitools' msiinfo for .msi ProductVersion fetching
 This replaces the insecure VBScript-based parsing, which has issues described
 at http://news.dieweltistgarnichtso.net/posts/gnome-thumbnailer-msi-fail.html
Origin: upstream, https://github.com/gnome-exe-thumbnailer/gnome-exe-thumbnailer/commit/1d8e3102dd8fd23431ae6127d14a236da6b4a4a5
Bug-Debian: https://bugs.debian.org/868705

Index: gnome-exe-thumbnailer/usr/bin/gnome-exe-thumbnailer
===================================================================
--- gnome-exe-thumbnailer.orig/usr/bin/gnome-exe-thumbnailer	2017-07-18 09:14:28.425066264 +0800
+++ gnome-exe-thumbnailer/usr/bin/gnome-exe-thumbnailer	2017-07-18 09:14:28.421066261 +0800
@@ -350,25 +350,10 @@
 # Get the version number:
 if [[ ${INPUTFILE##*.} = 'msi' ]]
 then
-	# Look for the ProductVersion property if user has the Microsoft (R) Windows Script Host installed:
-	if which wine && grep -v 'Wine placeholder DLL' $HOME/.wine/drive_c/windows/system32/cscript.exe
+	# Look for the ProductVersion property using msitools' msiinfo if present
+	if which msiinfo
 	then
-		# Workaround wine bug #19799: cscript crashes if you call WScript.Arguments(0)
-		# http://bugs.winehq.org/show_bug.cgi?id=19799
-		<<< "
-			Dim WI, DB, View, Record
-			Set WI = CreateObject(\"WindowsInstaller.Installer\")
-			Set DB = WI.OpenDatabase(\"$INPUTFILE\",0)
-			Set View = DB.OpenView(\"SELECT Value FROM Property WHERE Property = 'ProductVersion'\")
-			View.Execute
-			Wscript.Echo View.Fetch.StringData(1)
-		" iconv -f utf8 -t unicode > $TEMPFILE1.vbs
-
-		VERSION=$(
-			DISPLAY=NONE wine cscript.exe //E:vbs //NoLogo Z:\\tmp\\${TEMPFILE1##*/}.vbs 2>/dev/null \
-			| egrep -o '^[0-9]+\.[0-9]+(\.[0-9][0-9]?)?(beta)?'
-		)
-
+		VERSION=$(msiinfo export "$INPUTFILE" 'Property' | grep 'ProductVersion' | cut -f 2)
 	else
 		# Try to get the version number from extended file properties at least:
 		VERSION=$(
